#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

PKGDIR=debian/tmp
VERSION=$(shell grep "var Version" $(CURDIR)/shared/flex.go | cut -d'"' -f2)

# temporary build path (see http://golang.org/doc/code.html#GOPATH)
export DH_GOPKG := github.com/lxc/lxd
export GOPATH := $(CURDIR)/obj-$(DEB_BUILD_GNU_TYPE)
export USE_EMBEDDED := false

shlib_archs = amd64 s390x
ifneq (,$(filter $(DEB_HOST_ARCH),$(shlib_archs)))
	export IS_SHLIB_ARCH := true
else
	export IS_SHLIB_ARCH := false
endif

%:
	dh $@ --with systemd --buildsystem=golang --with=golang

# Ugly workaround for bundled dependencies
override_dh_auto_configure:
	dh_auto_configure

	# dh-golang's configure has copied the source tree into GOPATH. But
	# because lxd gets some dependencies from the archive and some from
	# the copies bundled in dist, we have to unpick a bunch of what it has
	# done and set it up again.

	# Remove the extra copy of dist dh-golang has copied onto GOPATH (or
	# when dh-golang tries to run go install github.com/lxc/lxd/... things
	# get very confused).
	rm -Rf ${GOPATH}/src/github.com/lxc/lxd/dist

	# Move the lxd source aside while we do this.
	mv ${GOPATH}/src/github.com/lxc/lxd ${GOPATH}/lxd.tmp

	# Clean GOPATH.
ifeq (true, $(IS_SHLIB_ARCH))
	rm -Rf ${GOPATH}/srcdeps/src
else
	rm -Rf ${GOPATH}/src
endif

ifeq ($(USE_EMBEDDED), true)
	# If we get all dependencies from dist, just copy it onto GOPATH.
	cp -R dist/src ${GOPATH}

	# But not the symlink for lxd.
	rm -f ${GOPATH}/src/github.com/lxc/lxd
else
	# If not, link depedencies from dist or from where the distro package
	# has installed it, as appropriate.

	# Packaged dependencies
	debian/helpers/link-from-installed github.com/golang/protobuf
	debian/helpers/link-from-installed github.com/gorilla/context
	debian/helpers/link-from-installed github.com/gorilla/mux
	debian/helpers/link-from-installed github.com/gorilla/websocket
	debian/helpers/link-from-installed github.com/mattn/go-sqlite3
	debian/helpers/link-from-installed golang.org/x/crypto

	# Packages that aren't in the archive
	debian/helpers/link-from-bundled github.com/dustinkirkland/golang-petname
	debian/helpers/link-from-bundled github.com/gosexy/gettext
	debian/helpers/link-from-bundled github.com/mattn/go-colorable
	debian/helpers/link-from-bundled github.com/mattn/go-runewidth
	debian/helpers/link-from-bundled github.com/olekukonko/tablewriter
	debian/helpers/link-from-bundled github.com/pborman/uuid
	debian/helpers/link-from-bundled github.com/syndtr/gocapability/capability
	debian/helpers/link-from-bundled gopkg.in/flosch/pongo2.v3
	debian/helpers/link-from-bundled gopkg.in/inconshreveable/log15.v2
	debian/helpers/link-from-bundled gopkg.in/lxc/go-lxc.v2
	debian/helpers/link-from-bundled gopkg.in/tomb.v2
	debian/helpers/link-from-bundled gopkg.in/yaml.v2
	debian/helpers/link-from-bundled github.com/stgraber/lxd-go-systemd
endif

	# And put the lxd source back again.
	mkdir -p ${GOPATH}/src/github.com/lxc/
	mv ${GOPATH}/lxd.tmp ${GOPATH}/src/github.com/lxc/lxd

override_dh_install:
	# Install the manpages
	export LD_LIBRARY_PATH=$(wildcard debian/libgolang*/usr/lib/$(DEB_HOST_MULTIARCH)); \
	mkdir -p $(PKGDIR)/usr/share/man/man1/; \
	help2man $(PKGDIR)/usr/bin/fuidshift -n "uid/gid shifter" --no-info > $(PKGDIR)/usr/share/man/man1/fuidshift.1; \
	help2man $(PKGDIR)/usr/bin/lxc -n "The container hypervisor - client" --no-info > $(PKGDIR)/usr/share/man/man1/lxc.1; \
	help2man $(PKGDIR)/usr/bin/lxd -n "The container hypervisor - daemon" --no-info > $(PKGDIR)/usr/share/man/man1/lxd.1; \
	help2man scripts/lxd-images -n "The container hypervisor - image importer" --version-string=$(VERSION) --no-info > $(PKGDIR)/usr/share/man/man1/lxd-images.1

	mkdir -p $(PKGDIR)/etc/bash_completion.d/
	cp config/bash/lxd-client $(PKGDIR)/etc/bash_completion.d

	# Prepare dev package
	rm -Rf $(PKGDIR)/usr/share/gocode/src/github.com/lxc/
	mkdir -p $(PKGDIR)/usr/share/gocode/src/github.com/lxc/
	cp -RL ${GOPATH}/src/github.com/lxc/lxd $(PKGDIR)/usr/share/gocode/src/github.com/lxc/
	rm -Rf $(PKGDIR)/usr/share/gocode/src/github.com/lxc/lxd/dist

	# Trigger normal dh_install
	dh_install

override_dh_installinit:
	dh_installinit
	dh_systemd_enable -plxd --name=lxd-startup

override_dh_auto_test:
	echo "The testsuite requires privileges and so is run through autopkgtest"
